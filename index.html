<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Malla Interactiva — Química y Farmacia (Universidad del Bío-Bío)</title>
<style>
  :root{
    --bg:#fffafc;
    --card:#ffffff;
    --rosa-1:#ffd7e8;
    --rosa-2:#ffb6d1;
    --verde-1:#dff7ea;
    --verde-2:#bfeed6;
    --texto:#233;
    --muted:#6f7478;
    --accent-border:rgba(0,0,0,0.06);
    --shadow: 0 8px 30px rgba(34,34,34,0.06);
    --radius:12px;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }

  html,body{height:100%;margin:0;padding:0;background:linear-gradient(180deg,#fffafc 0%, #f8fffb 100%); color:var(--texto);}
  .wrap{max-width:1180px;margin:28px auto;padding:18px;}
  header{
    text-align:center;margin-bottom:18px;
  }
  header h1{margin:0;font-size:20px;letter-spacing:0.6px}
  header p{margin:6px 0 0;color:var(--muted);font-size:13px}

  /* Top banner like the image (but in pastel rosa) */
  .banner{
    display:flex;align-items:center;justify-content:space-between;
    background:linear-gradient(90deg,var(--rosa-2),var(--rosa-1));
    padding:14px 18px;border-radius:14px;color:#24161e;box-shadow:var(--shadow);
    margin:18px 0;
  }
  .banner .title {font-weight:700;font-size:16px}
  .banner .subtitle {font-size:12px;color:rgba(34,34,34,0.6)}

  /* Grid of semesters */
  .malla-grid{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap:16px;
    margin-top:12px;
  }
  .semester {
    background:var(--card);
    border-radius:var(--radius);
    padding:12px;
    box-shadow:var(--shadow);
    min-height:120px;
    position:relative;
  }
  .sem-header{
    display:flex;align-items:center;justify-content:space-between;
    gap:8px;margin-bottom:10px;
  }
  .sem-label{
    background:linear-gradient(90deg,#fff,#fff0f5);
    border-radius:999px;padding:6px 10px;font-weight:700;font-size:13px;
    color:#6b2130;border:1px solid rgba(107,33,48,0.06);
    box-shadow: 0 6px 14px rgba(107,33,48,0.04);
  }
  .sem-sub{font-size:12px;color:var(--muted)}

  .subject-list{display:flex;flex-direction:column;gap:8px}
  .subject{
    display:flex;align-items:center;gap:10px;padding:8px;border-radius:10px;
    background:linear-gradient(90deg,#fff,#fff);
    border:1px solid var(--accent-border);
    cursor:pointer;transition:transform .12s ease, box-shadow .12s ease, opacity .12s ease;
    position:relative;
  }
  .subject:hover{ transform:translateY(-3px); box-shadow:0 10px 24px rgba(34,34,34,0.06); }
  .subject .check{
    width:28px;height:28px;border-radius:8px;flex-shrink:0;display:flex;align-items:center;justify-content:center;
    background:linear-gradient(180deg,#fff,#fafafa);border:1px solid rgba(34,34,34,0.04);
  }
  .subject .info{flex:1;min-width:0;}
  .subject .name{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .subject .meta{font-size:11px;color:var(--muted);margin-top:2px}

  /* Completed state */
  .subject.completed{
    background:linear-gradient(90deg,var(--verde-1), #f7fff9);
    border-left:4px solid #4b9072;
  }
  .subject.completed .check{ background:linear-gradient(90deg,#c6f1de,#e6fff5); border:1px solid rgba(75,144,114,0.12)}
  .subject.completed .check svg{opacity:1}

  /* Blocked state */
  .subject.blocked{
    opacity:0.48;cursor:default;pointer-events:none;
    background:linear-gradient(90deg,#fff7fb,#fffdf8);border-left:4px solid rgba(0,0,0,0.04);
  }
  .subject .check svg{width:14px;height:14px;opacity:0;transition:opacity .14s ease;fill:#27583a}
  .subject .lock{width:14px;height:14px;opacity:0.9;fill:rgba(36,36,36,0.18)}

  /* Tooltip for blocked with arrow */
  .tooltip{
    display:none;
    position:absolute;left:calc(100% + 10px);top:50%;transform:translateY(-50%);
    min-width:200px;padding:10px;border-radius:10px;background:#fff;border:1px solid rgba(34,34,34,0.06);
    box-shadow:0 12px 28px rgba(34,34,34,0.08);font-size:13px;color:var(--texto);z-index:30;
  }
  .subject.blocked:hover .tooltip{display:block}
  .tooltip small{display:block;color:var(--muted);margin-top:6px;font-size:12px}

  /* Sidebar / controls */
  .controls{
    margin-top:14px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;
  }
  .btn{
    padding:8px 12px;border-radius:10px;border:1px solid rgba(34,34,34,0.06);background:#fff;cursor:pointer;font-size:13px;
    box-shadow:var(--shadow);
  }
  .btn.primary{
    background:linear-gradient(90deg,var(--rosa-1),var(--verde-1));border:none;font-weight:700;
  }

  .progress{
    margin-top:12px;background:linear-gradient(90deg,#fff,#fff);padding:12px;border-radius:10px;border:1px solid var(--accent-border);
  }
  .progress .bar{height:12px;background:#f0f3f2;border-radius:999px;overflow:hidden}
  .progress .fill{height:100%;width:0%;background:linear-gradient(90deg,var(--rosa-1),var(--verde-1));transition:width .25s ease}

  footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}

  /* Responsive */
  @media (max-width:900px){
    .malla-grid{grid-template-columns: repeat(2, 1fr)}
  }
  @media (max-width:600px){
    .malla-grid{grid-template-columns: 1fr}
    .tooltip{left:auto;right:10px;top:auto;bottom:calc(100% + 8px);transform:none}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Química y Farmacia — Malla Interactiva (UBB)</h1>
      
    <div class="banner" role="banner">
      <div>
        <div class="title">CARRERA QUÍMICA Y FARMACIA</div>
        <div class="subtitle">Malla interactiva — Universidad del Bío-Bío</div>
      </div>

    <!-- Controles -->
    <div class="controls" role="region" aria-label="Controles de malla">
      <button id="resetBtn" class="btn" title="Reiniciar progreso">Reiniciar</button>
      <button id="selectAllBtn" class="btn">Marcar disponibles</button>
      <button id="clearAllBtn" class="btn">Desmarcar todo</button>
      <button id="exportBtn" class="btn">Exportar progreso </button>
      <label class="btn" style="display:inline-flex;align-items:center;gap:8px;cursor:pointer">
        Importar
        <input id="fileInput" type="file" accept="application/json" style="display:none">
      </label>
    </div>

    <!-- Grid malla -->
    <div id="mallaGrid" class="malla-grid" aria-live="polite" style="margin-top:14px"></div>

    <!-- Progress -->
    <div class="progress">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Progreso general</strong></div>
        <div id="progressMeta" style="color:var(--muted)">0 / 0</div>
      </div>
      <div style="margin-top:8px" class="bar"><div id="progressFill" class="fill"></div></div>
    </div>

    <footer>
      <div>Nota: Puedes editar la malla cambiando la lista de asignaturas en el script (variable <code>subjects</code>).</div>
    </footer>
  </div>

<script>
/*
  Datos de la malla (ejemplo basado en la estructura solicitada).
  Si quieres que adapte exactamente nombres/prerrequisitos reales del PDF,
  pega la lista en el mismo formato que usan los objetos aquí.
  Estructura:
    { id:'ID', name:'Nombre', sem: 1, prereqs: ['ID1','ID2'] }
*/

/* --- MALLA (puedes editar esta lista) --- */
const subjects = [
  { name:'Introducción a la Farmacia ', prereqs:[] },
  { name:'Álgebra y Trigonometría', prereqs:[] },
  { name:'Química General I', prereqs:[] },
  { name:'Biología General', prereqs:[] },
  { name:'Física Aplicada', prereqs:[] },
  { name:'Formación Integral', prereqs:[] },
  
  { name:'Ética Farmaceutica', prereqs:['Introducción a la Farmacia'] },
  { name:'Cálculo Diferencial e Integral', prereqs:['Álgebra y Trigonometría'] },
  { name:'Química General II', prereqs:['Química General I'] },
  { name:'Fisicoquímica', prereqs:['Física Aplicada'] },
  { name:'Formación Integral', prereqs:[] },

  { name:'Faramcia y Sociedad', prereqs:['Ética Farmaceutica'] },
  { name:'Química Analitica', prereqs:['Cálculo Diferencial e Integral', 'Química General II'] },
  { name:'Química Orgánica I',  prereqs:['Química General II'] },
  { name:'Biologia Molecular', prereqs:['Bioquímica'] },
  { name:'Histología', prereqs:['B1','Biología General'] },
  { name:'Ingles Comunicacional I', prereqs:[] },

  { name:'Analisis Instrumental', prereqs:['Química Analitica'] },
  { name:'Estadistica', prereqs:['Álgebra y Trigonometría'] },
  { name:'Química Orgánica II', prereqs:['Química Orgánica I'] },
  { name:'Fisiología I', prereqs:['Química Orgánica I'] },
  { name:'Ingles Comunicacional II', prereqs:['Ingles Comunicacional I'] },
  { name:'Formación Integral', prereqs:[] },

  { name:'Farmacología Básica: Fitoterapia', prereqs:['Analisis Instrumental'] },
  { name:'Control de Calidad Y Análisis Farmaceutico', prereqs:['Analisis Instrumental','Química Orgánica II'] },
  { name:'Salud Pública', prereqs:['Estadistica'] },
  { name:'Fisiología II', prereqs:['Fisiología I','Biologia Molecular'] },
  { name:'Ingles Comunicacional III', prereqs:['Ingles Comunicacional II'] },

  { name:'Farmacología Molecular I', prereqs:['Farmacología Básica: Fitoterapia'] },
  { name:'Farmacoquímica I', prereqs:['Farmacología Básica: Fitoterapia','Química Orgánica II'] },
  { name:'Investigación Farmacéutica', prereqs:['Farmacia y Sociedad'] },
  { name:'Fisiopatología', prereqs:['Fisiología II'] },
  { name:'Microbiología', prereqs:['Biologia Molecular','Histología','Fisiología II'] },
  { name:'Ingles Comunicacional IV', prereqs:['Ingles Comunicacional III'] },
  { name:'Práctica Farmacia Comunitaria', prereqs:['Farmacología Básica: Fitoterapia', 'Control de Calidad Y Análisis Farmaceutico', 'Salud Pública', 'Fisiología II'] },

  { name:'Farmacología Molecular II', prereqs:['Farmacología Molecular I'] },
  { name:'Farmacoquímica II', prereqs:['Farmacoquímica I'] },
  { name:'Bioquimica Clinica', prereqs:['Fisiopatologia'] },
  { name:'Fisiopatología', prereqs:['Fisiología II'] },
  { name:'Tecnologia Farmaceutica I', prereqs:['Fisicoquimica'] },
  { name:'Inmunologia Aplicada', prereqs:['Microbiologia'] },
  { name:'Formacion Integral', prereqs:[] },

  { name:'Farmacología Clinica y Terapéutica de Sistemas I', prereqs:['Farmacología Molecular II'] },
  { name:'Toxicología', prereqs:['Farmacología Molecular II'] },
  { name:'Biofarmacia y Farmacocinetica', prereqs:['Tecnologia Farmaceutica I'] },
  { name:'Fisiopatología', prereqs:['Fisiología II'] },
  { name:'Tecnologia Farmaceutica II', prereqs:['Tecnologia Farmaceutica I'] },
  { name:'Formacion Integral', prereqs:[] },
  { name:'Práctica Farmacia Comunitaria Intermedia', prereqs:['Farmacología Molecular II', 'Farmacoquímica II', 'Bioquimica Clinica', 'Tecnologia Farmaceutica II', 'Inmunologia Aplicada'] },

  { name:'Farmacología Clinica y Terapéutica de Sistemas II', prereqs:['Farmacología Clinica y Terapéutica de Sistemas I'] },
  { name:'Bromatologia', prereqs:['Toxicología'] },
  { name:'Farmacia Asistencial', prereqs:['Tecnologia Farmaceutica II'] },
  { name:'Legislación Farmacéutica', prereqs:[] },
  { name:'Administracipon y Gestión en Farmacia', prereqs:[] },
  { name:'Terapia Celular y Terapia Génica', prereqs:['Farmacología Molecular II'] },
  { name:'Farmacoterapia de Presición y Farmacogenomica', prereqs:['Farmacología Molecular II'] },

  { name:'Electivo I', prereqs:['240 CST'] },
  { name:'Electivo II', prereqs:['240 CST'] },
  { name:'Práctica Farmacia Comunitaria Final', prereqs:['240 CST'] },

  { name:'Actividad de Titulación', prereqs:['300 CST'] },

];
/* --- FIN MALLA --- */

const STORAGE_KEY = 'malla_qf_ubb_v2';
let state = {}; // { 'QG1': true, ... }

function init(){
  // cargar estado guardado
  const saved = localStorage.getItem(STORAGE_KEY);
  if(saved){
    try{ state = JSON.parse(saved); } catch(e){ state = {}; }
  }
  renderGrid();
  attachControls();
  updateProgress();
}

// Obtener semestres ordenados
function getSemesters(){
  const s = Array.from(new Set(subjects.map(x=>x.sem))).sort((a,b)=>a-b);
  return s;
}

function missingPrereqs(subject){
  if(!subject.prereqs || subject.prereqs.length === 0) return [];
  return subject.prereqs.filter(pid => !state[pid]);
}

function buildSubjectNode(sub){
  const item = document.createElement('div');
  item.className = 'subject';
  item.dataset.id = sub.id;

  const check = document.createElement('div');
  check.className = 'check';
  // Check SVG
  const svgCheck = document.createElementNS('http://www.w3.org/2000/svg','svg');
  svgCheck.setAttribute('viewBox','0 0 24 24');
  svgCheck.innerHTML = '<path d="M20.285 6.709a1 1 0 0 0-1.459-1.37l-9.12 9.497-4.06-3.96A1 1 0 0 0 4.5 12.4l4.83 4.71a1 1 0 0 0 1.43.03l9.525-9.13z"/>';
  svgCheck.style.width='14px';svgCheck.style.height='14px';
  check.appendChild(svgCheck);

  const info = document.createElement('div');info.className='info';
  const name = document.createElement('div');name.className='name';name.textContent = sub.name;
  const meta = document.createElement('div');meta.className='meta';meta.textContent = sub.id + ' • Sem ' + sub.sem;
  info.appendChild(name);info.appendChild(meta);

  item.appendChild(check);
  item.appendChild(info);

  // tooltip element
  const tooltip = document.createElement('div'); tooltip.className='tooltip';
  tooltip.innerHTML = '<strong>Bloqueada</strong><small></small>';

  const missing = missingPrereqs(sub);
  if(missing.length > 0){
    item.classList.add('blocked');
    tooltip.querySelector('small').textContent = 'Faltan: ' + missing.join(', ');
    item.appendChild(tooltip);
  } else {
    // clickable only if not blocked
    item.addEventListener('click', ()=> toggleComplete(sub.id));
  }

  if(state[sub.id]){
    item.classList.add('completed');
    // ensure svg visible
    svgCheck.style.opacity = '1';
  }

  return item;
}

function renderGrid(){
  const container = document.getElementById('mallaGrid');
  container.innerHTML = '';
  const semesters = getSemesters();

  for(const sem of semesters){
    const col = document.createElement('div');
    col.className = 'semester';
    col.setAttribute('data-sem', sem);

    const header = document.createElement('div'); header.className='sem-header';
    const label = document.createElement('div'); label.className='sem-label'; label.textContent = `Semestre ${sem}`;
    const sub = document.createElement('div'); sub.className='sem-sub'; sub.textContent = 'Ciclo básico';
    header.appendChild(label); header.appendChild(sub);
    col.appendChild(header);

    const list = document.createElement('div'); list.className='subject-list';

    const items = subjects.filter(s=>s.sem === sem).sort((a,b)=>a.name.localeCompare(b.name));
    if(items.length === 0){
      const empty = document.createElement('div'); empty.className='small'; empty.textContent = 'Sin asignaturas';
      col.appendChild(empty);
    } else {
      for(const it of items){
        const node = buildSubjectNode(it);
        list.appendChild(node);
      }
      col.appendChild(list);
    }

    container.appendChild(col);
  }

  updateProgress();
  persistState();
}

// Alterna completado y limpia dependientes si se desmarca
function toggleComplete(id){
  state[id] = !state[id];
  if(!state[id]) cascadeUnmark(id);
  renderGrid();
}

function cascadeUnmark(id){
  const dependents = subjects.filter(s => s.prereqs.includes(id));
  for(const d of dependents){
    if(state[d.id]){
      delete state[d.id];
      cascadeUnmark(d.id);
    }
  }
}

function persistState(){
  try{
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  } catch(e){
    console.warn('No se pudo guardar en localStorage', e);
  }
}

function updateProgress(){
  const total = subjects.length;
  const aprobadas = Object.keys(state).filter(k=> state[k] && subjects.some(s=>s.id===k)).length;
  const pct = total ? Math.round((aprobadas/total)*100) : 0;
  const fill = document.getElementById('progressFill');
  const meta = document.getElementById('progressMeta');
  if(fill) fill.style.width = pct + '%';
  if(meta) meta.textContent = `${aprobadas} / ${total} (${pct}%)`;
}

// Controles y eventos
function attachControls(){
  document.getElementById('resetBtn').addEventListener('click', ()=>{
    if(confirm('¿Reiniciar todo el progreso?')){
      state = {};
      persistState();
      renderGrid();
    }
  });

  document.getElementById('selectAllBtn').addEventListener('click', ()=>{
    for(const s of subjects){
      if(missingPrereqs(s).length === 0) state[s.id] = true;
    }
    persistState(); renderGrid();
  });

  document.getElementById('clearAllBtn').addEventListener('click', ()=>{
    state = {};
    persistState(); renderGrid();
  });

  document.getElementById('exportBtn').addEventListener('click', ()=>{
    const data = { date: new Date().toISOString(), state, subjects };
    const blob = new Blob([JSON.stringify(data, null, 2)],{type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'malla_qf_progreso.json';
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  });

  // Import
  const fileInput = document.getElementById('fileInput');
  fileInput.addEventListener('change', (ev)=>{
    const file = ev.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const parsed = JSON.parse(e.target.result);
        if(parsed && parsed.state){
          if(confirm('Importar progreso desde archivo (reemplazará el actual)?')){
            state = parsed.state;
            persistState(); renderGrid();
            alert('Importado correctamente.');
          }
        } else {
          alert('Archivo inválido: faltan datos de "state".');
        }
      } catch(err){
        alert('Error al leer archivo: ' + err.message);
      }
    };
    reader.readAsText(file);
    fileInput.value = '';
  });

  // Escucha cambios en localStorage desde otras pestañas
  window.addEventListener('storage', (e)=>{
    if(e.key === STORAGE_KEY){
      try{ state = JSON.parse(e.newValue || '{}'); } catch(e){ state = {}; }
      renderGrid();
    }
  });
}

init();
</script>
</body>
</html>
